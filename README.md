---

# cloudflare-workers-lb

---

# 基于 Worker 的负载均衡器

本项目展示了如何使用 Cloudflare Workers 实现带健康检查的负载均衡。负载均衡器可以在多个后端服务器之间分发请求，确保只将流量发送到健康的后端。

---

## 功能特性

1. **动态健康检查**：在每次请求时实时检查后端健康状态，保证准确性。
2. **缓存健康检查**：通过缓存后端健康状态，降低响应延迟，提高性能。
3. **自动故障切换**：当一个后端不可用时，自动尝试其他健康的后端。

---

## 使用方法

部署后，Worker 将作为反向代理，基于健康检查实现负载均衡。

### **主要接口**

1. `/health-check`：每个后端需要提供一个 `HEAD` 或 `GET` 类型的接口，用于 Worker 检查健康状态。

2. 入口 URL：将你的应用请求发送到 Worker 的入口 URL，它会自动将请求路由到健康的后端。

---

## 两种实现方式

本项目提供 **两种实现方式**，可根据需要选择：

---

### **方式一：实时健康检查**（worker_method1.js）

#### **工作原理**
- 每次请求时，动态检查所有后端的健康状态。
- 将请求分发到第一个健康的后端。
- 如果所有后端均不可用，返回 `503 Service Unavailable` 响应。

#### **适用场景**
- 后端健康状态变化较频繁。
- 请求量较低，或对实时性要求较高。

#### **使用步骤**
1. 在 `worker.js` 文件中使用第一段代码。
2. 配置 `backends` 列表为你的后端地址。
3. 确保每个后端提供 `/health-check` 接口。

#### **优点**
- 健康状态实时检查，准确性高。

#### **缺点**
- 请求延迟较高，因健康检查增加了处理时间。
- 高频请求时性能较差。

---

### **方式二：缓存健康检查**（_worker.js）

#### **工作原理**
- 定期检查后端健康状态，并将结果缓存到全局变量。
- 请求时直接使用缓存的健康后端列表，无需实时检查。
- 通过 **Scheduled Events** 定期更新健康状态。

#### **适用场景**
- 后端健康状态较为稳定。
- 请求量较高，对性能要求较高。

#### **使用步骤**
1. 在 `worker.js` 文件中使用第二段代码。
2. 配置 `backends` 列表为你的后端地址。
3. 确保每个后端提供 `/health-check` 接口。
4. 在 Cloudflare Workers 配置定时任务触发健康检查更新。

#### **优点**
- 请求处理速度快，性能更高。
- 更适合高流量场景。

#### **缺点**
- 健康状态可能存在滞后性，依赖更新频率。

---

## 区别总结

| **特性**              | **实时健康检查**                          | **缓存健康检查**                      |
|-----------------------|-------------------------------------------|---------------------------------------|
| **健康检查时机**       | 每次请求时动态执行                        | 定期执行，通过缓存直接使用            |
| **性能表现**           | 健康检查与请求同时进行，性能开销较高        | 请求时仅使用缓存，性能开销较低         |
| **响应延迟**           | 延迟较高，因包含健康检查耗时               | 延迟较低，直接使用缓存后端             |
| **健康状态实时性**     | 高，实时更新                              | 较低，取决于更新频率                  |
| **适用场景**           | 后端健康状态频繁变化，流量较低的场景        | 健康状态稳定，流量较大的场景           |

---

## 贡献

欢迎提交 PR 或 Issue，为项目提出建议或改进！

---
